<!DOCTYPE html> 
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title></title>
		<script type="text/javascript" src="libs/d3.v4.js"></script>
		<script type="text/javascript" src="libs/jquery-3.2.1.js"></script>
		<script type="text/javascript" src="lib.js"></script>
		<link rel="stylesheet" href="main.css" />
	</head>

	<body>
		<div id="main-container">
			<div id="start-screen">
				<div id="start-screen-text">
					Each year 1.3 billion tonnes of food is wasted globally, about a third of all that is produced. This is particularly alarming given estimates that we’ll likely have 2 billion more mouths to feed by mid-century—that is more than 9 billion people worldwide.<br /> 
					<br /> 

					Addressing our global food challenges demands that all of us become more thoughtful about the food we put on our plates and consider our contribution towards feeding the world in the future.
				</div>
				<br />
				<button id="start-button" onclick="selectTargetCountry()">Start</button>
			</div>
			<div id="content-container" style="display: none;">
				<div id="sidebar">
					<svg id="sidebar-canvas" width="100%" height="100%">
						<text id="current-location" class="title" x="45" y="200">Label 1</text>
				        <text id="feed-location" class="title" x="45" y="250">Label 2</text>
				        <text id="waste-headline" class="headline-bold" x="45" y="300">Label 3</text>
				        <text id="feed-headline" class="headline-bold" x="45" y="350">Label 4</text>
				        <text id="waste-descriptor" class="descripton" x="45" y="400">Label 5</text>
				        <text id="feed-descriptor" class="descripton" x="45" y="450">Label 6</text>	
					</svg>
					<form id="country-form" onSubmit="return applyOriginCountry()" action="">
			            <input type="text" class="headline" id="country-field" placeholder="country">
			        </form>	
				</div>
				<div id="map-container"></div>
			</div>
		</div>

		<script type="text/javascript">

			/**
			Constants
			*/						
			var UNKNOWN_COUNTRY_ID = "REST_OF_THE_WORLD";

			/**
			Global variables
			*/
			var mapCanvas;
			var sidebarCanvas;
			var originCountry;
			var targetCountry;				

			/**
			Load Data
			*/
			var foodWasteData = [{
				iso : "DK",
				valueMillions: "2343.5",
				year: 2009
			}];

			var bigMacIDX;

			d3.csv("BigMacIDX.csv", function(data){ 
				bigMacIDX = data;
				//console.log(data[0]);
			});		

			/**
			Load Resources
			*/
			d3.xml("resources/WorldMap_COUNTRYCODE.svg").mimeType("image/svg+xml").get(function(error, xml) {
			  if (error) throw error;
			  var svg = xml.documentElement;
			  svg.id = "map";
			  document.getElementById("map-container").appendChild(svg);
			  mapCanvas = d3.select("#map");
			  setup();
			});			

			function setup(){			
				d3.select("#content-container").style("opacity",0);
				d3.select("#content-container").style("display","block");

				// mapCanvas.selectAll("circle")
				// 	.style("opacity", 0)
				// 	.attr("class", "circle");	

				$(document).ready(function() {					
					
				});
			}			

			function registerMouseEvents(){				
				mapCanvas.selectAll("g").on("mouseover", function(){					
					var countryISO = this.id;					
					highlightCountry(countryISO);							
				}).on("mouseout", function(){
					var countryISO = this.id;			
					if(!countryISO || countryISO == UNKNOWN_COUNTRY_ID || countryISO == originCountry) return;
					unhighlightCountry(countryISO);
				}). on("click", function(){					
					var countryISO = this.id;
					//TODO just add click to groups with ID
					if(!countryISO) return;	
					unhighlightCountry(targetCountry, true);														
					targetCountry = countryISO;
					displayInfo(countryISO);
				});
			}

			function applyOriginCountry(event){
				//TODO
				var requestedCountry = document.getElementById("country-field").value.toLowerCase();
				if(requestedCountry == "australia"){				
					var country = mapCanvas.select("#AU");
					originCountry = "AU";

					mapCanvas.selectAll("circle").attr("class", "circle circle-deselected");									
					highlightCountry(originCountry);					
					registerMouseEvents();
				}
				return false;
			}

			function selectTargetCountry(){
				d3.select("body").transition().duration(500).style("background-color","white");
				var startScreen = d3.select("#start-screen");
				startScreen.transition().duration(500).style("opacity", 0)
				.on("end", function(){
					startScreen.style("display", "none");
					drawMainInterface();					
					d3.select("#country-field").node().focus();
				});
			}

			function displayInfo(countryISO){
				console.log("Comparing " + originCountry + " and " + countryISO);				
				//TODO
			}

			function highlightCountry(countryISO){							
				if(!countryISO || countryISO == UNKNOWN_COUNTRY_ID) return;
					
				var country = mapCanvas.select("g#"+countryISO);					
				var circles = country.selectAll("circle");
				circles.attr("class", "circle circle-selected color-" + countryISO);	
			}

			function unhighlightCountry(countryISO, enforce = false){
				if(!countryISO || countryISO == UNKNOWN_COUNTRY_ID) return;
				if(!enforce && (countryISO == originCountry || countryISO == targetCountry)) return;
					
				var country = mapCanvas.select("g#"+countryISO);									
				var circles = country.selectAll("circle");					
				country.selectAll("circle").attr("class", "circle circle-deselected");
			}

			function drawMainInterface(){					
				d3.select("#content-container").transition().duration(750).style("opacity",1);											
								
				// var circles = mapCanvas.selectAll("circle");
				// circles.transition()
				// 	.duration(250)
				// 	.delay(function(d,i) { return i * 0.5; })					
				// 	.style("opacity", 1).on("end", function(d,i){
				// 		if(i == circles.size() -1){
				// 			circles.style("opacity","");							
				// 		}
				// 	});
								
				drawSidebar();
			}
		
			function drawSidebar(){				
				var sidebarCanvas=d3.select("#sidebar-canvas");
				var title = sidebarCanvas.append("text")
				.attr("class", "title")
				.attr("x", 45)
				.attr("y", 45)
				.text("I live in");
			}

		</script>
	</body>
</html>