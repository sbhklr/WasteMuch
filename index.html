<!DOCTYPE html> 
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title></title>
		<script type="text/javascript" src="libs/d3.v4.js"></script>
		<script type="text/javascript" src="libs/jquery-3.2.1.js"></script>
		<script type="text/javascript" src="lib.js"></script>
		<link rel="stylesheet" href="main.css" />
	</head>

	<body>
		<div id="main-container">
			<div id="start-screen">
				<div id="start-screen-text">
					Each year 1.3 billion tonnes of food is wasted globally, about a third of all that is produced. This is particularly alarming given estimates that we’ll likely have 2 billion more mouths to feed by mid-century—that is more than 9 billion people worldwide.<br /> 
					<br /> 

					Addressing our global food challenges demands that all of us become more thoughtful about the food we put on our plates and consider our contribution towards feeding the world in the future.
				</div>
				<br />
				<button id="start-button" onclick="enableSelectTargetCountry()">Start</button>
			</div>
			<div id="content-container" style="display: none;">
				<div id="content-header">Feed the World</div>
				<div id="sidebar">
					<svg id="sidebar-canvas" width="100%" height="100%">
						<text id="country-field-title" class="title" x="45" y="45">I live in</text>
						<g id="description-fields-origin">
							<g>
								<line x1="48" y1="35" x2="48" y2="46" style="stroke:rgb(0,0,0);stroke-width:1" />
								<circle id="current-pin" fill="#CCCCCC" cx="48" cy="30" r="5" />
							</g>
							<text id="current-location" class="title" x="65" y="45">Origin</text>
					        <text id="waste-headline" class="headline-bold" x="44" y="130">1234</text>
					        <text id="waste-headline-currency" class="headline-bold" x="44" y="170">CUR</text>				        
					        <text id="waste-descriptor" class="descripton" x="45" y="185">				        
						        <tspan x="45" dy="1.2em">worth of food</tspan>
		    					<tspan x="45" dy="1.2em">is wasted every</tspan>
		    					<tspan x="45" dy="1.2em">year in Denmark</tspan>
					        </text>					        
				        </g>
				        <g id="description-fields-target">
				        	<text id="feed-descriptor" class="descripton" x="45" y="420">which could feed</text>	
					        <text id="feed-headline" class="headline-bold" x="44" y="465">People fed</text>
					        <text id="feed-location" class="title" x="65" y="635">Target</text>
					        <g>
								<line x1="48" y1="625" x2="48" y2="636" style="stroke:rgb(0,0,0);stroke-width:1" />
					        	<circle id="feed-pin" fill="#CCCCCC" cx="48" cy="622" r="5" />
					        </g>
				        </g>
					</svg>
					<form id="country-form" onSubmit="return applyOriginCountry()" action="">
			            <input type="text" class="headline" id="country-field" placeholder="country">
			        </form>	
				</div>
				<div id="map-container"></div>
			</div>
		</div>

		<script type="text/javascript">

			/**
			Constants
			*/						
			var UNKNOWN_COUNTRY_ID = "REST_OF_THE_WORLD";

			/**
			Global variables
			*/
			var mapCanvas;
			var sidebarCanvas;
			var originCountry;
			var targetCountry;	

			var foodWasteData;			
			var bigMacIDXData;

			/**
			Load Data
			*/			
			var foodWasteDataRaw = [
			{
				iso : "DK",
				valueMillions: 25849,
				currency: "DKK",
				valueMillionsUSD: 3864,
				year: 2009
			},
			{
				iso : "AU",
				valueMillions: 847,
				currency: "AUD",
				valueMillionsUSD: 629,
				year: 2009
			}];			

			d3.csv("resources/BigMacIDX.csv", function(data){ 
				bigMacIDXData = d3.map(data, function(d){ return d.iso; });				
			});		

			/**
			Load Resources
			*/
			d3.xml("resources/WorldMap_COUNTRYCODE.svg").mimeType("image/svg+xml").get(function(error, xml) {
			  if (error) throw error;
			  var svg = xml.documentElement;
			  svg.id = "map";
			  document.getElementById("map-container").appendChild(svg);			  
			  setup();
			});			

			function setup(){	
				mapCanvas = d3.select("#map");
			  	sidebarCanvas=d3.select("#sidebar-canvas");		
				d3.select("#content-container").style("opacity",0);
				d3.select("#content-container").style("display","block");
				sidebarCanvas.select("#description-fields-origin").style("opacity",0);
				sidebarCanvas.select("#description-fields-target").style("opacity",0);

				foodWasteData = d3.map(foodWasteDataRaw, function(d) { return d.iso; });	

				// mapCanvas.selectAll("circle")
				// 	.style("opacity", 0)
				// 	.attr("class", "circle");	

				$(document).ready(function() { });
			}			

			function registerMouseEvents(){				
				mapCanvas.selectAll("g").on("mouseover", function(){					
					var countryISO = this.id;					
					highlightCountry(countryISO);							
				}).on("mouseout", function(){
					var countryISO = this.id;			
					if(!countryISO || countryISO == UNKNOWN_COUNTRY_ID || countryISO == originCountry) return;
					unhighlightCountry(countryISO);
				}). on("click", function(){					
					var countryISO = this.id;
					//TODO just add click to groups with ID
					if(!countryISO || countryISO == UNKNOWN_COUNTRY_ID) return;	
					unhighlightCountry(targetCountry, true);														
					targetCountry = countryISO;
					displayInfo(countryISO);
				});
			}

			/**
			Data fetching
			*/

			function getWastedMoney(countryISO){				
				return foodWasteData.get(countryISO).valueMillions;	
			}

			function getCurrency(countryISO){
				return foodWasteData.get(countryISO).currency;	
			}

			function getCountryName(countryISO){
				return bigMacIDXData.get(countryISO).country;
			}

			function getFedPeople(countryISO, money){
				//TODO
				return 1234;
			}

			/**
			UI Modification
			*/

			function enableSelectTargetCountry(){
				d3.select("body").transition().duration(500).style("background-color","white");
				var startScreen = d3.select("#start-screen");
				startScreen.transition().duration(500).style("opacity", 0)
				.on("end", function(){
					startScreen.style("display", "none");
					drawMainInterface();					
					d3.select("#country-field").node().focus();
				});
			}

			function applyOriginCountry(event){
				//TODO
				var requestedCountry = document.getElementById("country-field").value.toLowerCase();
				if(requestedCountry == "australia"){				
					var country = mapCanvas.select("#AU");
					originCountry = "AU";

					mapCanvas.selectAll("circle").attr("class", "circle circle-deselected");									
					highlightCountry(originCountry);					

					d3.select("#country-field").node().blur();					
					d3.select("#country-field").attr("disabled", "disabled");	
					d3.select("#country-form").transition().duration(500).style("opacity",0);					
					sidebarCanvas.select("circle#current-pin").attr("class", "color-" + originCountry);
					sidebarCanvas.select("#country-field-title").transition().duration(500).style("opacity",0);
					sidebarCanvas.select("#description-fields-origin").transition().duration(500).style("opacity",1);
					
					sidebarCanvas.select("#waste-headline").text(getWastedMoney(originCountry));
					sidebarCanvas.select("#waste-headline-currency").text(getCurrency(originCountry));
					sidebarCanvas.select("#current-location").text(getCountryName(originCountry));

					registerMouseEvents();
				}
				return false;
			}

			function displayInfo(countryISO){
				console.log("Comparing " + originCountry + " and " + countryISO);								
				sidebarCanvas.select("circle#feed-pin").attr("class", "color-" + countryISO);	
				sidebarCanvas.select("#feed-location").text(getCountryName(countryISO));
				sidebarCanvas.select("#feed-headline").attr("class", "headline-bold color-" + countryISO);
				startCountUpTimer(sidebarCanvas.select("#feed-headline"), getFedPeople(countryISO));

				sidebarCanvas.select("#description-fields-target").transition().duration(500).style("opacity",1);
			}
		
			function highlightCountry(countryISO){							
				if(!countryISO || countryISO == UNKNOWN_COUNTRY_ID) return;
					
				var country = mapCanvas.select("g#"+countryISO);					
				var circles = country.selectAll("circle");
				circles.attr("class", "circle circle-selected color-" + countryISO);
			}

			function unhighlightCountry(countryISO, enforce = false){
				if(!countryISO || countryISO == UNKNOWN_COUNTRY_ID) return;
				if(!enforce && (countryISO == originCountry || countryISO == targetCountry)) return;
					
				var country = mapCanvas.select("g#"+countryISO);									
				var circles = country.selectAll("circle");					
				country.selectAll("circle").attr("class", "circle circle-deselected");
			}

			function drawMainInterface(){					
				d3.select("#content-container").transition().duration(750).style("opacity",1);											
								
				// var circles = mapCanvas.selectAll("circle");
				// circles.transition()
				// 	.duration(250)
				// 	.delay(function(d,i) { return i * 0.5; })					
				// 	.style("opacity", 1).on("end", function(d,i){
				// 		if(i == circles.size() -1){
				// 			circles.style("opacity","");							
				// 		}
				// 	});											
			}			

			function startCountUpTimer(element, number){
				var duration = 1000;
				var interval = 25;
				var counter = 0;
				var limit = number;
				var step = Math.ceil(limit / (duration / interval));

				var timer = setInterval(function(){
					counter += step;					
					element.text(counter);
					if(counter >= limit){
						clearInterval(timer);
						element.text(limit);
					}
				}, interval);				
			}	
		</script>
	</body>
</html>